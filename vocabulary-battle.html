<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯æ±‡PKç«æŠ€åœº Pro - Vocabulary Battle Arena</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .top-bar h1 {
            color: #667eea;
            font-size: 1.8em;
        }

        .top-controls {
            display: flex;
            gap: 15px;
        }

        .btn-small {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-history {
            background: #3498db;
            color: white;
        }

        .btn-settings {
            background: #95a5a6;
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* ä¸»è¦å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* éš¾åº¦é€‰æ‹© */
        .difficulty-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .difficulty-btn {
            padding: 20px;
            border: 3px solid #ecf0f1;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .difficulty-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .difficulty-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15, #764ba215);
        }

        .difficulty-btn .level {
            font-weight: bold;
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .difficulty-btn .desc {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .difficulty-btn .word-count {
            margin-top: 8px;
            font-size: 0.85em;
            color: #95a5a6;
        }

        /* é˜Ÿä¼è®¾ç½® */
        .team-setup-panel input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .team-setup-panel input:focus {
            outline: none;
            border-color: #667eea;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover,
        .color-option.selected {
            border-color: #2c3e50;
            transform: scale(1.1);
        }

        /* æ¸¸æˆè®¾ç½® */
        .game-settings label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .game-settings input[type="number"],
        .game-settings select {
            width: 80px;
            padding: 8px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
        }

        .start-game-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            display: none;
        }

        .game-area.active {
            display: block;
        }

        /* æ¯”åˆ†æ¿ */
        .scoreboard {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 25px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .team-score {
            text-align: center;
        }

        .team-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .score-display {
            font-size: 4em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .score-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: #95a5a6;
            font-weight: bold;
        }

        .round-info {
            text-align: center;
            margin-top: 15px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* æŒ‘æˆ˜å¡ç‰‡ */
        .challenge-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .challenge-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .word-display {
            font-size: 4em;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            backdrop-filter: blur(10px);
            letter-spacing: 3px;
        }

        .word-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .word-info-item {
            background: rgba(255,255,255,0.15);
            padding: 10px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .timer-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin-top: 25px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: white;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .time-left {
            margin-top: 10px;
            font-size: 1.3em;
        }

        /* ç­”é¢˜åŒº */
        .answer-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .answer-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-top: 5px solid;
        }

        .answer-box h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1.1em;
            resize: vertical;
            font-family: 'Georgia', serif;
            line-height: 1.6;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .answer-textarea:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .answer-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .char-count {
            font-family: monospace;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submitted-indicator {
            display: none;
            background: #27ae60;
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        .submitted-indicator.show {
            display: block;
        }

        /* è¯„åˆ†ç»“æœ */
        .result-section {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .result-section.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .winner-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            font-weight: bold;
        }

        .result-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .result-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-top: 5px solid;
        }

        .result-card h4 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .answer-display {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-style: italic;
            color: #34495e;
            line-height: 1.8;
            border-left: 4px solid #667eea;
        }

        .score-breakdown {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .score-label {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
        }

        .score-bar-container {
            flex: 2;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 1s ease-out;
            border-radius: 5px;
        }

        .score-value {
            width: 50px;
            text-align: right;
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .ai-feedback {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .ai-feedback h5 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-feedback p {
            color: #34495e;
            line-height: 1.6;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #7f8c8d;
        }

        /* æ¸¸æˆæ§åˆ¶æŒ‰é’® */
        .game-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-next {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-restart {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .game-area {
                order: 1;
            }

            .answer-section,
            .result-comparison {
                grid-template-columns: 1fr;
            }

            .scoreboard {
                grid-template-columns: 1fr;
            }

            .score-vs {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ  -->
        <div class="top-bar">
            <h1>ğŸ† Vocabulary Battle Arena</h1>
            <div class="top-controls">
                <button class="btn-small btn-history" onclick="showHistory()">
                    ğŸ“Š æˆ˜ç»©æ’è¡Œ
                </button>
                <button class="btn-small btn-settings" onclick="showSettings()">
                    âš™ï¸ è®¾ç½®
                </button>
            </div>
        </div>

        <div class="main-layout">
            <!-- ä¾§è¾¹æ è®¾ç½® -->
            <div class="sidebar" id="setupSidebar">
                <!-- éš¾åº¦é€‰æ‹© -->
                <div class="panel">
                    <h3>ğŸ¯ é€‰æ‹©éš¾åº¦</h3>
                    <div class="difficulty-selector">
                        <div class="difficulty-btn active" data-level="cet4" onclick="selectDifficulty('cet4')">
                            <div class="level">CET-4 å››çº§</div>
                            <div class="desc">é€‚åˆå¤§å­¦åŸºç¡€é˜¶æ®µ</div>
                            <div class="word-count">è¯åº“: 500+ é«˜é¢‘è¯</div>
                        </div>
                        <div class="difficulty-btn" data-level="cet6" onclick="selectDifficulty('cet6')">
                            <div class="level">CET-6 å…­çº§</div>
                            <div class="desc">è¿›é˜¶è¯æ±‡æŒ‘æˆ˜</div>
                            <div class="word-count">è¯åº“: 400+ è¿›é˜¶è¯</div>
                        </div>
                        <div class="difficulty-btn" data-level="graduate" onclick="selectDifficulty('graduate')">
                            <div class="level">è€ƒç ”/é›…æ€</div>
                            <div class="desc">é«˜çº§è¯æ±‡å¯¹å†³</div>
                            <div class="word-count">è¯åº“: 300+ é«˜é˜¶è¯</div>
                        </div>
                    </div>
                </div>

                <!-- é˜Ÿä¼è®¾ç½® -->
                <div class="panel team-setup-panel">
                    <h3>ğŸ‘¥ é˜Ÿä¼è®¾ç½®</h3>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: bold;">Team A åç§°</label>
                        <input type="text" id="teamAName" placeholder="è¾“å…¥é˜Ÿä¼Aåç§°" value="çº¢é˜Ÿ">
                        <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: bold;">é˜Ÿä¼é¢œè‰²</label>
                        <div class="color-picker" id="colorPickerA">
                            <div class="color-option selected" style="background: #e74c3c" data-color="#e74c3c"></div>
                            <div class="color-option" style="background: #9b59b6" data-color="#9b59b6"></div>
                            <div class="color-option" style="background: #3498db" data-color="#3498db"></div>
                            <div class="color-option" style="background: #e67e22" data-color="#e67e22"></div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: bold;">Team B åç§°</label>
                        <input type="text" id="teamBName" placeholder="è¾“å…¥é˜Ÿä¼Båç§°" value="è“é˜Ÿ">
                        <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: bold;">é˜Ÿä¼é¢œè‰²</label>
                        <div class="color-picker" id="colorPickerB">
                            <div class="color-option" style="background: #e74c3c" data-color="#e74c3c"></div>
                            <div class="color-option" style="background: #9b59b6" data-color="#9b59b6"></div>
                            <div class="color-option selected" style="background: #3498db" data-color="#3498db"></div>
                            <div class="color-option" style="background: #e67e22" data-color="#e67e22"></div>
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆè®¾ç½® -->
                <div class="panel game-settings">
                    <h3>âš™ï¸ æ¸¸æˆè®¾ç½®</h3>
                    <label>
                        <span>ç­”é¢˜æ—¶é—´</span>
                        <select id="timeLimit">
                            <option value="30">30ç§’</option>
                            <option value="45">45ç§’</option>
                            <option value="60" selected>60ç§’</option>
                            <option value="90">90ç§’</option>
                        </select>
                    </label>
                    <label>
                        <span>è½®æ¬¡æ•°é‡</span>
                        <input type="number" id="maxRounds" value="5" min="1" max="20">
                    </label>
                    <label>
                        <span>æ˜¾ç¤ºè¯ä¹‰</span>
                        <select id="showDefinition">
                            <option value="yes">æ˜¯</option>
                            <option value="no" selected>å¦</option>
                        </select>
                    </label>

                    <button class="start-game-btn" onclick="startGame()">
                        ğŸ® å¼€å§‹å¯¹æˆ˜
                    </button>
                </div>
            </div>

            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div class="game-area" id="gameArea">
                <!-- æ¯”åˆ†æ¿ -->
                <div class="scoreboard">
                    <div class="team-score">
                        <div class="team-name" id="teamANameDisplay" style="color: #e74c3c">çº¢é˜Ÿ</div>
                        <div class="score-display" id="scoreA" style="color: #e74c3c">0</div>
                    </div>
                    <div class="score-vs">VS</div>
                    <div class="team-score">
                        <div class="team-name" id="teamBNameDisplay" style="color: #3498db">è“é˜Ÿ</div>
                        <div class="score-display" id="scoreB" style="color: #3498db">0</div>
                    </div>
                    <div class="round-info">
                        Round <span id="currentRound">1</span> / <span id="totalRounds">5</span>
                    </div>
                </div>

                <!-- æŒ‘æˆ˜å¡ç‰‡ -->
                <div class="challenge-card">
                    <div class="challenge-header">è¯·ç”¨ä»¥ä¸‹è¯æ±‡é€ ä¸€ä¸ªå¥å­</div>
                    <div class="word-display" id="currentWord">LOADING...</div>
                    <div class="word-info">
                        <div class="word-info-item" id="wordType">
                            è¯æ€§: <span id="wordTypeValue">n.</span>
                        </div>
                        <div class="word-info-item" id="wordDefinition" style="display: none;">
                            é‡Šä¹‰: <span id="wordDefinitionValue">---</span>
                        </div>
                    </div>
                    <div class="timer-bar">
                        <div class="timer-fill" id="timerFill"></div>
                    </div>
                    <div class="time-left">
                        â±ï¸ å‰©ä½™æ—¶é—´: <span id="timeLeft">60</span> ç§’
                    </div>
                </div>

                <!-- ç­”é¢˜åŒº -->
                <div class="answer-section">
                    <div class="answer-box" id="answerBoxA">
                        <h3>
                            <span id="teamAIcon">ğŸ”´</span>
                            <span id="teamAAnswerTitle">çº¢é˜Ÿç­”é¢˜</span>
                        </h3>
                        <textarea 
                            id="answerA" 
                            class="answer-textarea" 
                            placeholder="è¯·è¾“å…¥åŒ…å«è¯¥è¯æ±‡çš„å¥å­...&#10;&#10;ğŸ’¡ æç¤ºï¼šå¥å­è¶Šåœ°é“ã€ç”¨è¯è¶Šå‡†ç¡®ï¼Œå¾—åˆ†è¶Šé«˜ï¼"
                        ></textarea>
                        <div class="answer-meta">
                            <span class="char-count">å­—ç¬¦: <span id="charCountA">0</span></span>
                            <span class="words-count">å•è¯: <span id="wordCountA">0</span></span>
                        </div>
                        <button class="submit-btn" id="submitBtnA" onclick="submitAnswer('A')" style="background: linear-gradient(135deg, #e74c3c, #c0392b)">
                            æäº¤ç­”æ¡ˆ
                        </button>
                        <div class="submitted-indicator" id="submittedA">
                            âœ“ å·²æäº¤ï¼Œç­‰å¾…å¯¹æ–¹...
                        </div>
                    </div>

                    <div class="answer-box" id="answerBoxB">
                        <h3>
                            <span id="teamBIcon">ğŸ”µ</span>
                            <span id="teamBAnswerTitle">è“é˜Ÿç­”é¢˜</span>
                        </h3>
                        <textarea 
                            id="answerB" 
                            class="answer-textarea" 
                            placeholder="è¯·è¾“å…¥åŒ…å«è¯¥è¯æ±‡çš„å¥å­...&#10;&#10;ğŸ’¡ æç¤ºï¼šå¥å­è¶Šåœ°é“ã€ç”¨è¯è¶Šå‡†ç¡®ï¼Œå¾—åˆ†è¶Šé«˜ï¼"
                        ></textarea>
                        <div class="answer-meta">
                            <span class="char-count">å­—ç¬¦: <span id="charCountB">0</span></span>
                            <span class="words-count">å•è¯: <span id="wordCountB">0</span></span>
                        </div>
                        <button class="submit-btn" id="submitBtnB" onclick="submitAnswer('B')" style="background: linear-gradient(135deg, #3498db, #2980b9)">
                            æäº¤ç­”æ¡ˆ
                        </button>
                        <div class="submitted-indicator" id="submittedB">
                            âœ“ å·²æäº¤ï¼Œç­‰å¾…å¯¹æ–¹...
                        </div>
                    </div>
                </div>

                <!-- è¯„åˆ†ç»“æœ -->
                <div class="result-section" id="resultSection">
                    <div class="winner-banner" id="winnerBanner">
                        ğŸ‰ æœ¬è½®è·èƒœï¼šçº¢é˜Ÿ (+24åˆ†)
                    </div>

                    <div class="result-comparison">
                        <div class="result-card" id="resultCardA">
                            <h4><span id="resultTeamAName">ğŸ”´ çº¢é˜Ÿ</span></h4>
                            <div class="answer-display" id="answerDisplayA">
                                "The ambitious entrepreneur launched a groundbreaking startup."
                            </div>

                            <div class="score-breakdown">
                                <div class="score-item">
                                    <div class="score-label">è¯­æ³•å‡†ç¡®æ€§</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="grammarBarA" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="grammarScoreA">0</div>
                                </div>

                                <div class="score-item">
                                    <div class="score-label">è¯æ±‡è¿ç”¨</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="vocabBarA" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="vocabScoreA">0</div>
                                </div>

                                <div class="score-item">
                                    <div class="score-label">å¥å­è´¨é‡</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="qualityBarA" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="qualityScoreA">0</div>
                                </div>

                                <div class="score-item">
                                    <div class="score-label">åˆ›æ„åŠ åˆ†</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="creativityBarA" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="creativityScoreA">0</div>
                                </div>

                                <div class="score-item" style="background: linear-gradient(135deg, #667eea15, #764ba215); font-weight: bold;">
                                    <div class="score-label" style="font-size: 1.1em;">æœ¬è½®å¾—åˆ†</div>
                                    <div class="score-bar-container"></div>
                                    <div class="score-value" id="totalScoreA" style="font-size: 1.3em;">0</div>
                                </div>
                            </div>

                            <div class="ai-feedback">
                                <h5>ğŸ¤– AI ç‚¹è¯„</h5>
                                <p id="feedbackA">å¥å­ç»“æ„æ¸…æ™°ï¼Œè¯æ±‡è¿ç”¨æ°å½“ï¼Œè¯­æ³•å‡†ç¡®æ— è¯¯ã€‚å»ºè®®å¯ä»¥å¢åŠ æ›´å¤šç»†èŠ‚æè¿°ã€‚</p>
                            </div>
                        </div>

                        <div class="result-card" id="resultCardB">
                            <h4><span id="resultTeamBName">ğŸ”µ è“é˜Ÿ</span></h4>
                            <div class="answer-display" id="answerDisplayB">
                                "She is very ambitious person."
                            </div>

                            <div class="score-breakdown">
                                <div class="score-item">
                                    <div class="score-label">è¯­æ³•å‡†ç¡®æ€§</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="grammarBarB" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="grammarScoreB">0</div>
                                </div>

                                <div class="score-item">
                                    <div class="score-label">è¯æ±‡è¿ç”¨</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="vocabBarB" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="vocabScoreB">0</div>
                                </div>

                                <div class="score-item">
                                    <div class="score-label">å¥å­è´¨é‡</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="qualityBarB" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="qualityScoreB">0</div>
                                </div>

                                <div class="score-item">
                                    <div class="score-label">åˆ›æ„åŠ åˆ†</div>
                                    <div class="score-bar-container">
                                        <div class="score-bar-fill" id="creativityBarB" style="width: 0%"></div>
                                    </div>
                                    <div class="score-value" id="creativityScoreB">0</div>
                                </div>

                                <div class="score-item" style="background: linear-gradient(135deg, #667eea15, #764ba215); font-weight: bold;">
                                    <div class="score-label" style="font-size: 1.1em;">æœ¬è½®å¾—åˆ†</div>
                                    <div class="score-bar-container"></div>
                                    <div class="score-value" id="totalScoreB" style="font-size: 1.3em;">0</div>
                                </div>
                            </div>

                            <div class="ai-feedback">
                                <h5>ğŸ¤– AI ç‚¹è¯„</h5>
                                <p id="feedbackB">è¯­æ³•æœ‰è¯¯ï¼š"a ambitious" åº”ä¸º "an ambitious"ã€‚è¯æ±‡ä½¿ç”¨æ­£ç¡®ï¼Œä½†å¥å­è¾ƒä¸ºç®€å•ï¼Œå»ºè®®å¢åŠ å¤æ‚åº¦ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆæ§åˆ¶ -->
                <div class="game-controls">
                    <button class="control-btn btn-next" id="nextRoundBtn" onclick="nextRound()" style="display: none;">
                        â–¶ï¸ ä¸‹ä¸€è½®
                    </button>
                    <button class="control-btn btn-export" onclick="exportResults()">
                        ğŸ“Š å¯¼å‡ºæˆç»©
                    </button>
                    <button class="control-btn btn-restart" onclick="confirmRestart()">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">AIæ­£åœ¨è¯„åˆ†ä¸­...</div>
            <div class="loading-subtext">åˆ†æè¯­æ³•ã€è¯æ±‡å’Œå¥å­è´¨é‡</div>
        </div>
    </div>

    <script>
        // ============ è¯æ±‡åº“ ============
        const VOCABULARY_BANK = {
            cet4: [
                { word: 'ambitious', type: 'adj.', meaning: 'æœ‰é›„å¿ƒçš„ï¼›æœ‰é‡å¿ƒçš„' },
                { word: 'convenient', type: 'adj.', meaning: 'æ–¹ä¾¿çš„ï¼›ä¾¿åˆ©çš„' },
                { word: 'efficient', type: 'adj.', meaning: 'æ•ˆç‡é«˜çš„ï¼›æœ‰èƒ½åŠ›çš„' },
                { word: 'essential', type: 'adj.', meaning: 'å¿…è¦çš„ï¼›æœ¬è´¨çš„' },
                { word: 'flexible', type: 'adj.', meaning: 'çµæ´»çš„ï¼›æŸ”éŸ§çš„' },
                { word: 'generous', type: 'adj.', meaning: 'æ…·æ…¨çš„ï¼›å¤§æ–¹çš„' },
                { word: 'independent', type: 'adj.', meaning: 'ç‹¬ç«‹çš„ï¼›è‡ªä¸»çš„' },
                { word: 'maintain', type: 'v.', meaning: 'ç»´æŒï¼›ä¿æŒ' },
                { word: 'obtain', type: 'v.', meaning: 'è·å¾—ï¼›å¾—åˆ°' },
                { word: 'previous', type: 'adj.', meaning: 'å…ˆå‰çš„ï¼›ä»¥å‰çš„' },
                { word: 'relevant', type: 'adj.', meaning: 'ç›¸å…³çš„ï¼›åˆ‡é¢˜çš„' },
                { word: 'significant', type: 'adj.', meaning: 'é‡å¤§çš„ï¼›æœ‰æ„ä¹‰çš„' },
                { word: 'strategy', type: 'n.', meaning: 'ç­–ç•¥ï¼›æˆ˜ç•¥' },
                { word: 'traditional', type: 'adj.', meaning: 'ä¼ ç»Ÿçš„ï¼›æƒ¯ä¾‹çš„' },
                { word: 'universal', type: 'adj.', meaning: 'æ™®éçš„ï¼›é€šç”¨çš„' },
            ],
            cet6: [
                { word: 'advocate', type: 'v./n.', meaning: 'æå€¡ï¼›æ‹¥æŠ¤ï¼›æå€¡è€…' },
                { word: 'comprehensive', type: 'adj.', meaning: 'ç»¼åˆçš„ï¼›å…¨é¢çš„' },
                { word: 'controversial', type: 'adj.', meaning: 'æœ‰äº‰è®®çš„' },
                { word: 'facilitate', type: 'v.', meaning: 'ä¿ƒè¿›ï¼›ä½¿ä¾¿åˆ©' },
                { word: 'implement', type: 'v.', meaning: 'å®æ–½ï¼›æ‰§è¡Œ' },
                { word: 'innovative', type: 'adj.', meaning: 'åˆ›æ–°çš„ï¼›é©æ–°çš„' },
                { word: 'legislation', type: 'n.', meaning: 'ç«‹æ³•ï¼›æ³•å¾‹' },
                { word: 'perspective', type: 'n.', meaning: 'è§‚ç‚¹ï¼›è§†è§’' },
                { word: 'sustainable', type: 'adj.', meaning: 'å¯æŒç»­çš„' },
                { word: 'utilize', type: 'v.', meaning: 'åˆ©ç”¨ï¼›ä½¿ç”¨' },
                { word: 'accumulate', type: 'v.', meaning: 'ç§¯ç´¯ï¼›ç§¯èš' },
                { word: 'authentic', type: 'adj.', meaning: 'çœŸå®çš„ï¼›å¯ä¿¡çš„' },
                { word: 'catalyst', type: 'n.', meaning: 'å‚¬åŒ–å‰‚ï¼›ä¿ƒè¿›å› ç´ ' },
                { word: 'coherent', type: 'adj.', meaning: 'è¿è´¯çš„ï¼›ä¸€è‡´çš„' },
                { word: 'diversity', type: 'n.', meaning: 'å¤šæ ·æ€§ï¼›å·®å¼‚' },
            ],
            graduate: [
                { word: 'ambiguous', type: 'adj.', meaning: 'æ¨¡æ£±ä¸¤å¯çš„ï¼›å«ç³Šä¸æ¸…çš„' },
                { word: 'arbitrary', type: 'adj.', meaning: 'ä»»æ„çš„ï¼›æ­¦æ–­çš„' },
                { word: 'connotation', type: 'n.', meaning: 'å†…æ¶µï¼›éšå«æ„ä¹‰' },
                { word: 'deteriorate', type: 'v.', meaning: 'æ¶åŒ–ï¼›é€€åŒ–' },
                { word: 'eloquent', type: 'adj.', meaning: 'é›„è¾©çš„ï¼›æœ‰è¯´æœåŠ›çš„' },
                { word: 'implicit', type: 'adj.', meaning: 'å«è“„çš„ï¼›æš—ç¤ºçš„' },
                { word: 'paradox', type: 'n.', meaning: 'æ‚–è®ºï¼›çŸ›ç›¾' },
                { word: 'profound', type: 'adj.', meaning: 'æ·±åˆ»çš„ï¼›æ·±è¿œçš„' },
                { word: 'rigorous', type: 'adj.', meaning: 'ä¸¥æ ¼çš„ï¼›ä¸¥å¯†çš„' },
                { word: 'scrutinize', type: 'v.', meaning: 'ä»”ç»†æ£€æŸ¥ï¼›å®¡æŸ¥' },
                { word: 'sophisticated', type: 'adj.', meaning: 'å¤æ‚çš„ï¼›ç²¾å¯†çš„' },
                { word: 'tangible', type: 'adj.', meaning: 'æœ‰å½¢çš„ï¼›å®é™…çš„' },
                { word: 'undermine', type: 'v.', meaning: 'å‰Šå¼±ï¼›ç ´å' },
                { word: 'versatile', type: 'adj.', meaning: 'å¤šæ‰å¤šè‰ºçš„ï¼›é€šç”¨çš„' },
                { word: 'zealous', type: 'adj.', meaning: 'çƒ­å¿ƒçš„ï¼›çƒ­æƒ…çš„' },
            ]
        };

        //ç”±äºä»£ç å¾ˆé•¿ï¼Œè®©æˆ‘ç»§ç»­å®Œæˆå‰©ä½™éƒ¨åˆ†...

        // ============ æ¸¸æˆçŠ¶æ€ ============
        let gameState = {
            difficulty: 'cet4',
            round: 1,
            maxRounds: 5,
            timeLimit: 60,
            showDefinition: false,
            currentWord: null,
            teamA: {
                name: 'çº¢é˜Ÿ',
                color: '#e74c3c',
                score: 0,
                answer: '',
                submitted: false
            },
            teamB: {
                name: 'è“é˜Ÿ',
                color: '#3498db',
                score: 0,
                answer: '',
                submitted: false
            },
            timerInterval: null,
            timeLeft: 60,
            history: []
        };

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            setupColorPickers();
            setupTextareaCounters();
            loadConfig();
        });

        // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨
        function setupColorPickers() {
            document.querySelectorAll('#colorPickerA .color-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('#colorPickerA .color-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    gameState.teamA.color = el.dataset.color;
                });
            });

            document.querySelectorAll('#colorPickerB .color-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('#colorPickerB .color-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    gameState.teamB.color = el.dataset.color;
                });
            });
        }

        // è®¾ç½®æ–‡æœ¬è®¡æ•°å™¨
        function setupTextareaCounters() {
            ['A', 'B'].forEach(team => {
                const textarea = document.getElementById(`answer${team}`);
                textarea.addEventListener('input', () => {
                    const text = textarea.value;
                    document.getElementById(`charCount${team}`).textContent = text.length;
                    document.getElementById(`wordCount${team}`).textContent = text.trim().split(/\s+/).filter(w => w).length;
                });
            });
        }

        // åŠ è½½é…ç½®ï¼ˆä»URLå‚æ•°ï¼‰
        function loadConfig() {
            const params = new URLSearchParams(window.location.search);
            const configStr = params.get('config');
            if (configStr) {
                try {
                    const config = JSON.parse(decodeURIComponent(configStr));
                    window.API_CONFIG = config;
                } catch(e) {
                    console.error('é…ç½®åŠ è½½å¤±è´¥', e);
                }
            }
            
            // é»˜è®¤æ¼”ç¤ºæ¨¡å¼
            if (!window.API_CONFIG) {
                window.API_CONFIG = { provider: 'demo' };
            }
        }

        // ============ éš¾åº¦é€‰æ‹© ============
        function selectDifficulty(level) {
            gameState.difficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
        }

        // ============ æ¸¸æˆæµç¨‹ ============
        function startGame() {
            // è·å–è®¾ç½®
            gameState.teamA.name = document.getElementById('teamAName').value || 'çº¢é˜Ÿ';
            gameState.teamB.name = document.getElementById('teamBName').value || 'è“é˜Ÿ';
            gameState.maxRounds = parseInt(document.getElementById('maxRounds').value);
            gameState.timeLimit = parseInt(document.getElementById('timeLimit').value);
            gameState.showDefinition = document.getElementById('showDefinition').value === 'yes';

            // é‡ç½®æ¸¸æˆ
            gameState.round = 1;
            gameState.teamA.score = 0;
            gameState.teamB.score = 0;
            gameState.history = [];

            // æ›´æ–°æ˜¾ç¤º
            updateTeamDisplay();
            document.getElementById('totalRounds').textContent = gameState.maxRounds;
            
            // åˆ‡æ¢åˆ°æ¸¸æˆåŒº
            document.getElementById('setupSidebar').style.display = 'none';
            document.getElementById('gameArea').classList.add('active');

            // å¼€å§‹ç¬¬ä¸€è½®
            startRound();
        }

        function updateTeamDisplay() {
            // æ›´æ–°é˜Ÿåå’Œé¢œè‰²
            document.getElementById('teamANameDisplay').textContent = gameState.teamA.name;
            document.getElementById('teamANameDisplay').style.color = gameState.teamA.color;
            document.getElementById('teamBNameDisplay').textContent = gameState.teamB.name;
            document.getElementById('teamBNameDisplay').style.color = gameState.teamB.color;

            // æ›´æ–°ç­”é¢˜åŒºé¢œè‰²
            document.getElementById('answerBoxA').style.borderTopColor = gameState.teamA.color;
            document.getElementById('answerBoxB').style.borderTopColor = gameState.teamB.color;
            
            document.getElementById('teamAAnswerTitle').textContent = gameState.teamA.name + 'ç­”é¢˜';
            document.getElementById('teamBAnswerTitle').textContent = gameState.teamB.name + 'ç­”é¢˜';

            // æ›´æ–°æŒ‰é’®é¢œè‰²
            const btnA = document.getElementById('submitBtnA');
            const btnB = document.getElementById('submitBtnB');
            btnA.style.background = `linear-gradient(135deg, ${gameState.teamA.color}, ${adjustColor(gameState.teamA.color, -20)})`;
            btnB.style.background = `linear-gradient(135deg, ${gameState.teamB.color}, ${adjustColor(gameState.teamB.color, -20)})`;
        }

        // è°ƒæ•´é¢œè‰²äº®åº¦
        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        function startRound() {
            // é‡ç½®çŠ¶æ€
            gameState.teamA.answer = '';
            gameState.teamA.submitted = false;
            gameState.teamB.answer = '';
            gameState.teamB.submitted = false;
            gameState.timeLeft = gameState.timeLimit;

            // éšæœºé€‰è¯
            const words = VOCABULARY_BANK[gameState.difficulty];
            gameState.currentWord = words[Math.floor(Math.random() * words.length)];

            // æ›´æ–°ç•Œé¢
            document.getElementById('currentRound').textContent = gameState.round;
            document.getElementById('currentWord').textContent = gameState.currentWord.word.toUpperCase();
            document.getElementById('wordTypeValue').textContent = gameState.currentWord.type;
            
            if (gameState.showDefinition) {
                document.getElementById('wordDefinition').style.display = 'block';
                document.getElementById('wordDefinitionValue').textContent = gameState.currentWord.meaning;
            } else {
                document.getElementById('wordDefinition').style.display = 'none';
            }

            // é‡ç½®ç­”é¢˜åŒº
            ['A', 'B'].forEach(team => {
                document.getElementById(`answer${team}`).value = '';
                document.getElementById(`answer${team}`).disabled = false;
                document.getElementById(`submitBtn${team}`).disabled = false;
                document.getElementById(`submitted${team}`).classList.remove('show');
                document.getElementById(`charCount${team}`).textContent = '0';
                document.getElementById(`wordCount${team}`).textContent = '0';
            });

            // éšè—ç»“æœ
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('nextRoundBtn').style.display = 'none';

            // å¯åŠ¨è®¡æ—¶å™¨
            startTimer();
        }

        function startTimer() {
            // æ¸…é™¤æ—§è®¡æ—¶å™¨
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }

            // æ›´æ–°æ˜¾ç¤º
            updateTimerDisplay();

            // å¯åŠ¨æ–°è®¡æ—¶å™¨
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    autoSubmitAll();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            document.getElementById('timeLeft').textContent = gameState.timeLeft;
            const percentage = (gameState.timeLeft / gameState.timeLimit) * 100;
            document.getElementById('timerFill').style.width = percentage + '%';
        }

        // ============ ç­”é¢˜æäº¤ ============
        function submitAnswer(team) {
            const textarea = document.getElementById(`answer${team}`);
            const answer = textarea.value.trim();

            // éªŒè¯
            if (!answer) {
                alert('è¯·å…ˆè¾“å…¥ç­”æ¡ˆï¼');
                return;
            }

            if (!answer.toLowerCase().includes(gameState.currentWord.word.toLowerCase())) {
                alert(`ç­”æ¡ˆå¿…é¡»åŒ…å«å•è¯ "${gameState.currentWord.word}"ï¼`);
                return;
            }

            // ä¿å­˜ç­”æ¡ˆ
            gameState[`team${team}`].answer = answer;
            gameState[`team${team}`].submitted = true;

            // æ›´æ–°UI
            textarea.disabled = true;
            document.getElementById(`submitBtn${team}`).disabled = true;
            document.getElementById(`submitted${team}`).classList.add('show');

            // æ£€æŸ¥æ˜¯å¦éƒ½æäº¤äº†
            if (gameState.teamA.submitted && gameState.teamB.submitted) {
                clearInterval(gameState.timerInterval);
                evaluateRound();
            }
        }

        function autoSubmitAll() {
            // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨æäº¤
            ['A', 'B'].forEach(team => {
                if (!gameState[`team${team}`].submitted) {
                    const answer = document.getElementById(`answer${team}`).value.trim();
                    gameState[`team${team}`].answer = answer || 'æœªä½œç­”';
                }
            });

            evaluateRound();
        }

        // ============ AIè¯„åˆ† ============
        async function evaluateRound() {
            document.getElementById('loadingOverlay').classList.add('show');

            try {
                // è¯„åˆ†ä¸¤é˜Ÿç­”æ¡ˆ
                const [resultA, resultB] = await Promise.all([
                    evaluateAnswer(gameState.teamA.answer, 'A'),
                    evaluateAnswer(gameState.teamB.answer, 'B')
                ]);

                // æ›´æ–°åˆ†æ•°
                gameState.teamA.score += resultA.total;
                gameState.teamB.score += resultB.total;

                // è®°å½•å†å²
                gameState.history.push({
                    round: gameState.round,
                    word: gameState.currentWord.word,
                    teamA: { answer: gameState.teamA.answer, ...resultA },
                    teamB: { answer: gameState.teamB.answer, ...resultB }
                });

                // æ˜¾ç¤ºç»“æœ
                displayResults(resultA, resultB);

            } catch (error) {
                console.error('è¯„åˆ†é”™è¯¯:', error);
                alert('AIè¯„åˆ†å‡ºé”™ï¼Œè¯·é‡è¯•');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        async function evaluateAnswer(answer, team) {
            if (answer === 'æœªä½œç­”' || !answer) {
                return {
                    grammar: 0,
                    vocabulary: 0,
                    quality: 0,
                    creativity: 0,
                    total: 0,
                    feedback: 'æœªåœ¨è§„å®šæ—¶é—´å†…ä½œç­”'
                };
            }

            // è¿™é‡Œå¯ä»¥é›†æˆçœŸå®API
            if (window.API_CONFIG && window.API_CONFIG.provider !== 'demo') {
                // çœŸå®APIè°ƒç”¨ï¼ˆåç»­å®ç°ï¼‰
                return await callAIAPI(answer);
            }

            // æ¼”ç¤ºæ¨¡å¼ï¼šæœ¬åœ°è¯„åˆ†
            return evaluateLocal(answer);
        }

        function evaluateLocal(answer) {
            // åŸºç¡€åˆ†æ
            const words = answer.split(/\s+/);
            const wordCount = words.length;
            const hasTargetWord = answer.toLowerCase().includes(gameState.currentWord.word.toLowerCase());

            // è¯­æ³•è¯„åˆ†ï¼ˆç®€åŒ–ï¼‰
            let grammar = 6;
            if (answer.match(/^[A-Z]/)) grammar += 1; // é¦–å­—æ¯å¤§å†™
            if (answer.match(/[.!?]$/)) grammar += 1; // æ­£ç¡®ç»“å°¾
            if (wordCount >= 8) grammar += 1; // å¥å­é•¿åº¦é€‚ä¸­
            if (!answer.match(/\s{2,}/)) grammar += 1; // æ— å¤šä½™ç©ºæ ¼

            // è¯æ±‡è¿ç”¨
            let vocabulary = hasTargetWord ? 5 : 0;
            if (wordCount >= 10) vocabulary += 2;
            const avgWordLength = words.reduce((sum, w) => sum + w.length, 0) / wordCount;
            if (avgWordLength > 5) vocabulary += 2;
            vocabulary += Math.min(1, Math.floor(wordCount / 15));

            // å¥å­è´¨é‡
            let quality = 5;
            if (wordCount >= 12) quality += 2;
            if (answer.includes(',') || answer.includes(';')) quality += 2; // æœ‰æ ‡ç‚¹ç»“æ„
            if (words.some(w => w.length > 8)) quality += 1; // æœ‰è¾ƒé•¿å•è¯

            // åˆ›æ„åŠ åˆ†
            let creativity = Math.floor(Math.random() * 3) + 2; // 2-4åˆ†éšæœº
            if (wordCount > 15) creativity += 1;

            // ç”Ÿæˆåé¦ˆ
            const feedbacks = [
                'å¥å­ç»“æ„æ¸…æ™°ï¼Œç”¨è¯æ°å½“ï¼Œè¯­æ³•å‡†ç¡®ã€‚å»ºè®®å¢åŠ ç»†èŠ‚æè¿°ä½¿è¡¨è¾¾æ›´ç”ŸåŠ¨ã€‚',
                'è¯æ±‡è¿ç”¨å¾—å½“ï¼Œè¡¨è¾¾æµç•…ã€‚å¯ä»¥å°è¯•ä½¿ç”¨æ›´å¤šé«˜çº§è¯æ±‡æå‡æ¡£æ¬¡ã€‚',
                'è¯­æ³•æ­£ç¡®ï¼Œé€»è¾‘è¿è´¯ã€‚å¥å­ç»“æ„å¯ä»¥æ›´åŠ å¤šæ ·åŒ–ã€‚',
                'æ•´ä½“ä¸é”™ï¼å¯ä»¥åœ¨å¥å­ä¸­æ·»åŠ æ—¶é—´ã€åœ°ç‚¹ç­‰çŠ¶è¯­ä¸°å¯Œå†…å®¹ã€‚',
                'è¡¨è¾¾å‡†ç¡®ï¼Œç»§ç»­ä¿æŒã€‚å°è¯•ä½¿ç”¨ä»å¥å¢åŠ å¥å­å¤æ‚åº¦ä¼šæ›´å¥½ã€‚'
            ];

            let feedback = feedbacks[Math.floor(Math.random() * feedbacks.length)];

            // æ£€æµ‹å¸¸è§é”™è¯¯
            if (!answer.match(/^[A-Z]/)) {
                feedback = 'æ³¨æ„ï¼šå¥å­åº”è¯¥ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚' + feedback;
                grammar -= 2;
            }
            if (!answer.match(/[.!?]$/)) {
                feedback = 'æ³¨æ„ï¼šå¥å­ç»“å°¾ç¼ºå°‘æ ‡ç‚¹ç¬¦å·ã€‚' + feedback;
                grammar -= 2;
            }

            return {
                grammar: Math.max(0, Math.min(10, grammar)),
                vocabulary: Math.max(0, Math.min(10, vocabulary)),
                quality: Math.max(0, Math.min(10, quality)),
                creativity: Math.max(0, Math.min(5, creativity)),
                total: Math.max(0, grammar + vocabulary + quality + creativity),
                feedback
            };
        }

        // ============ ç»“æœæ˜¾ç¤º ============
        function displayResults(resultA, resultB) {
            // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
            document.getElementById('scoreA').textContent = gameState.teamA.score;
            document.getElementById('scoreB').textContent = gameState.teamB.score;

            // ç¡®å®šè·èƒœè€…
            let winnerText;
            if (resultA.total > resultB.total) {
                winnerText = `ğŸ‰ æœ¬è½®è·èƒœï¼š${gameState.teamA.name} (+${resultA.total}åˆ†)`;
            } else if (resultB.total > resultA.total) {
                winnerText = `ğŸ‰ æœ¬è½®è·èƒœï¼š${gameState.teamB.name} (+${resultB.total}åˆ†)`;
            } else {
                winnerText = `ğŸ¤ æœ¬è½®å¹³å±€ï¼åŒæ–¹å„å¾— ${resultA.total} åˆ†`;
            }
            document.getElementById('winnerBanner').textContent = winnerText;

            // æ˜¾ç¤ºç­”æ¡ˆå’Œè¯„åˆ† - Team A
            displayTeamResult('A', resultA);
            
            // æ˜¾ç¤ºç­”æ¡ˆå’Œè¯„åˆ† - Team B
            displayTeamResult('B', resultB);

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').classList.add('show');

            // æ˜¾ç¤ºä¸‹ä¸€è½®æŒ‰é’®ï¼ˆå¦‚æœè¿˜æœ‰è½®æ¬¡ï¼‰
            if (gameState.round < gameState.maxRounds) {
                document.getElementById('nextRoundBtn').style.display = 'inline-block';
            } else {
                // æ¸¸æˆç»“æŸ
                showFinalResults();
            }
        }

        function displayTeamResult(team, result) {
            // æ›´æ–°ç­”æ¡ˆæ˜¾ç¤º
            document.getElementById(`answerDisplay${team}`).textContent = `"${gameState[`team${team}`].answer}"`;
            
            // æ›´æ–°å„é¡¹åˆ†æ•°
            setTimeout(() => {
                updateScoreBar(team, 'grammar', result.grammar, 10);
                updateScoreBar(team, 'vocab', result.vocabulary, 10);
                updateScoreBar(team, 'quality', result.quality, 10);
                updateScoreBar(team, 'creativity', result.creativity, 5);
            }, 300);

            // æ›´æ–°æ€»åˆ†
            document.getElementById(`totalScore${team}`).textContent = result.total;

            // æ›´æ–°åé¦ˆ
            document.getElementById(`feedback${team}`).textContent = result.feedback;

            // æ›´æ–°ç»“æœå¡ç‰‡é¢œè‰²
            document.getElementById(`resultCard${team}`).style.borderTopColor = gameState[`team${team}`].color;
        }

        function updateScoreBar(team, type, score, maxScore) {
            const percentage = (score / maxScore) * 100;
            document.getElementById(`${type}Bar${team}`).style.width = percentage + '%';
            document.getElementById(`${type}Score${team}`).textContent = score + '/' + maxScore;
        }

        // ============ ä¸‹ä¸€è½®/é‡æ–°å¼€å§‹ ============
        function nextRound() {
            gameState.round++;
            startRound();
        }

        function confirmRestart() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                location.reload();
            }
        }

        // ============ æœ€ç»ˆç»“æœ ============
        function showFinalResults() {
            const winner = gameState.teamA.score > gameState.teamB.score ? gameState.teamA.name :
                          gameState.teamB.score > gameState.teamA.score ? gameState.teamB.name :
                          'å¹³å±€';
            
            document.getElementById('nextRoundBtn').style.display = 'none';
            document.getElementById('winnerBanner').innerHTML = `
                ğŸ† æ¸¸æˆç»“æŸï¼<br>
                æœ€ç»ˆèƒœè€…ï¼š<strong style="font-size: 1.2em">${winner}</strong><br>
                ${gameState.teamA.name}: ${gameState.teamA.score}åˆ† | ${gameState.teamB.name}: ${gameState.teamB.score}åˆ†
            `;

            // ä¿å­˜åˆ°å†å²è®°å½•
            saveToHistory();
        }

        // ============ å†å²è®°å½• ============
        function saveToHistory() {
            const history = JSON.parse(localStorage.getItem('vocabulary_battle_history') || '[]');
            history.push({
                date: new Date().toISOString(),
                teamA: { name: gameState.teamA.name, score: gameState.teamA.score },
                teamB: { name: gameState.teamB.name, score: gameState.teamB.score },
                difficulty: gameState.difficulty,
                rounds: gameState.maxRounds
            });

            // åªä¿ç•™æœ€è¿‘20åœº
            if (history.length > 20) {
                history.shift();
            }

            localStorage.setItem('vocabulary_battle_history', JSON.stringify(history));
        }

        function showHistory() {
            const history = JSON.parse(localStorage.getItem('vocabulary_battle_history') || '[]');
            if (history.length === 0) {
                alert('æš‚æ— å†å²è®°å½•');
                return;
            }

            let html = 'ğŸ“Š å†å²æˆ˜ç»©\n\n';
            history.reverse().forEach((game, index) => {
                const date = new Date(game.date).toLocaleString('zh-CN');
                html += `${index + 1}. ${date}\n`;
                html += `   ${game.teamA.name}: ${game.teamA.score} vs ${game.teamB.name}: ${game.teamB.score}\n`;
                html += `   éš¾åº¦: ${game.difficulty.toUpperCase()} | è½®æ¬¡: ${game.rounds}\n\n`;
            });

            alert(html);
        }

        // ============ å¯¼å‡ºåŠŸèƒ½ ============
        function exportResults() {
            if (gameState.history.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            let csv = 'è½®æ¬¡,å•è¯,é˜Ÿä¼Aç­”æ¡ˆ,é˜Ÿä¼Aå¾—åˆ†,é˜Ÿä¼Bç­”æ¡ˆ,é˜Ÿä¼Bå¾—åˆ†\n';
            gameState.history.forEach(h => {
                csv += `${h.round},${h.word},"${h.teamA.answer}",${h.teamA.total},"${h.teamB.answer}",${h.teamB.total}\n`;
            });

            // ä¸‹è½½CSV
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è¯æ±‡PK_${gameState.teamA.name}_vs_${gameState.teamB.name}_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        function showSettings() {
            alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...\n\nå¯é…ç½®é¡¹ï¼š\n- è‡ªå®šä¹‰è¯æ±‡åº“\n- è°ƒæ•´è¯„åˆ†æƒé‡\n- éŸ³æ•ˆå¼€å…³');
        }
    </script>
</body>
</html>